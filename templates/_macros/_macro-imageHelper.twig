{#
  Image Helper
  ------------------------------------------------------------

  {% import '_macros/_macro-imageHelper.twig' as image  %}
#}

{% apply spaceless %}
  {# Get Image Extension #}
  {%- macro getImageExtension(image) -%}
    {%- if image ??? null -%}
      {%- if image is iterable -%}
        {{- image.extension | lower -}}
      {%- else -%}
        {{- image | split('.') | last | lower -}}
      {%- endif -%}
    {%- endif -%}
  {%- endmacro -%}


  {# Get Image Extension #}
  {%- macro isTransformable(image) -%}
    {%- set skipTransformsForThisExtensions = ['gif', 'svg'] -%}
    {%- set extension = _self.getImageExtension(image) -%}
    {%- if extension not in skipTransformsForThisExtensions -%}
      {{- 'true' -}}
    {%- else -%}
      {{- 'false' -}}
    {%- endif -%}
  {%- endmacro -%}



  {# Render Image #}
  {%- macro renderImage(image, transform, lazy = true, objectFit = null, calcDominantColor = false) -%}
    {%- if image ??? null -%}
      {%- set transform = transform | default('landscape') -%}
      {%- set placeholder = _self.getPlaceHolder(craft.imager.transformImage(image, transform)|first.url, transform) -%}
      {%- set focalpoint = image.getFocalpoint('asCss') -%}
      {%- set imageTitle = image.title -%}
      {%- if _self.isTransformable(image) == 'true' -%}
        {%- set srcset = _self.getSrcset(image, transform) -%}
        <img class="{{ lazy ? 'lazyload' : '' }}"
          {%- if objectFit -%}
            style="object-fit: {{ objectFit }}; object-position: {{ focalpoint | default('50% 50%') }}"
          {%- endif -%}
             src="{{- placeholder -}}"
          {%- if lazy -%}
            data-srcset="{{- srcset -}}"
            data-sizes="auto"
          {%- else -%}
            srcset="{{- srcset -}}"
            sizes="100vw"
          {%- endif -%}
             alt="{{ imageTitle }}"
             data-rootimage="{{- craft.imager.transformImage(image, transform)|last.url -}}"/>
      {%- else -%}
        {%- set imageUrl = image.getUrl() -%}
        <img class="{{ lazy ? 'lazyload' : '' }}"
          {%- if objectFit -%}
            style="object-fit: {{ objectFit }}; object-position: {{ focalpoint | default('50% 50%') }}"
          {%- endif -%}
          {%- if lazy -%}
            src="{{- placeholder -}}"
            data-src="{{- imageUrl -}}"
            data-sizes="auto"
          {%- else -%}
            src="{{- imageUrl -}}"
            sizes="100vw"
          {%- endif -%}
             alt="{{- imageTitle -}}"/>
      {%- endif -%}
    {%- endif -%}
  {%- endmacro -%}



  {# Render NoScript #}
  {%- macro renderNoScript(image) -%}
    {%- if image ??? null -%}
      <noscript><img src="{{ image.getUrl() }}" alt="{{ image.title }}" /></noscript>
    {%- endif -%}
  {%- endmacro -%}



  {# Render Source #}
  {%- macro renderSource(image, transform, mediaQuery) -%}
    {%- if image ??? null -%}
      {%- set transform = transform | default('landscape') -%}
      {%- if craft.imager.clientSupportsWebp() and craft.imager.serverSupportsWebp() -%}
        <source data-sizes="auto"
                data-srcset="{{- _self.getSrcset(image, transform, 'webp') -}}"
                media="{{- mediaQuery -}}"
                type="image/webp" />
      {%- endif -%}
      <source sizes="auto"
              media="{{- mediaQuery -}}"
              srcset="{{- _self.getSrcset(image, transform) -}}" />
    {%- endif -%}
  {%- endmacro -%}



  {# Get srcset #}
  {%- macro getSrcset(image, transform, format) -%}
    {%- if image ??? null -%}
      {%- set transform = transform | default('landscape') -%}
      {%- if _self.isTransformable(image) == 'true' -%}
        {{- craft.imager.srcset(craft.imager.transformImage(image, transform, { format: format | default(null) })) | trim -}}
      {%- else -%}
        {{- image.url -}}
      {%- endif -%}
    {%- endif -%}
  {%- endmacro -%}



  {# Get Dominant Color #}
  {%- macro getDominantColor(image, calcDominantColor = false) -%}
    {%- set dominantColor = 'transparent' -%}
    {%- if craft.app.config.general.custom.dominantColor -%}
      {%- set dominantColor = craft.app.config.general.custom.dominantColor -%}
    {%- endif -%}
    {% if calcDominantColor and not craft.app.config.general.custom.localDevPerformance and not image.extension | lower == 'png' %}
      {%- if _self.isTransformable(image) == 'true' -%}
        {# Create Mini Image for Dominant Color #}
        {%- set image = craft.imager.transformImage(image, 'dominantColor')|first -%}
        {%- set dominantColor = craft.imager.getDominantColor(image) -%}
      {%- endif -%}
    {% endif %}
    {{- dominantColor -}}
  {%- endmacro -%}



  {# Get Placeholder #}
  {%- macro getPlaceHolder(image, transform, calcDominantColor = false) -%}
    {% if image ??? null %}
      {%- set transform = transform | default('landscape') -%}
      {%- if _self.isTransformable(image) == 'true' -%}
        {%- set transformedImage = craft.imager.transformImage(image, transform)|first -%}
        {{- craft.imager.placeholder({
          color: _self.getDominantColor(transformedImage, calcDominantColor),
          width: transformedImage.width,
          height: transformedImage.height
        }) -}}
      {%- else -%}
        {{- craft.imager.placeholder({
          color: 'transparent',
          width: image.width,
          height: image.height,
        }) -}}
      {%- endif -%}
    {%- endif -%}
  {%- endmacro -%}
{%- endapply -%}
